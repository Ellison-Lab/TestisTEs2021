---
title: 'Figures'
date: "`r Sys.Date()`"
output:
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: ["float"]
    toc: true
  html_document:
    toc: true
mainfont: Times New Roman
header-includes:
- \usepackage{caption}
- \usepackage{float}
- \usepackage{longtable}
- \usepackage{booktabs}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{sectsty} \sectionfont{\centering}
- \usepackage{lscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---


```{r setup, include=FALSE}
ragg_png = function(..., res = 300) {
  ragg::agg_png(..., res = res, units = "in")
}

knitr::opts_chunk$set(fig.pos="H", echo = F, message = F, warning = F, error = F, fig.path = './figures/', dev = c('ragg_png'), dpi=300,  out.extra="", fig.align='center', dev.args = list(ragg_png= list(scaling=1.5) ))
```

```{r libraries, cache=F}
library(tidyverse)
library(jsonlite)
library(arrow)
library(ComplexHeatmap)
library(pheatmap)
library(rtracklayer)
library(ggforce)
library(gt)
library(ragg)
library(DESeq2)
```

```{r data-01, cache=F}
w1118.obs <- open_dataset("~/finalized/larval-w1118-testes/obs", format='arrow')
w1118.var <- open_dataset("~/finalized/larval-w1118-testes/var", format='arrow')
w1118.expr <- open_dataset("~/finalized/larval-w1118-testes/expr", format='arrow')
w1118.scaled <- open_dataset("~/finalized/larval-w1118-testes/scaled", format='arrow')
w1118.grid <- open_dataset("~/finalized/larval-w1118-testes/grid_enr", format='arrow')
w1118.gep_enr <- open_dataset("~/finalized/larval-w1118-testes/optimal_gep_enr", format='arrow')
w1118.gep_usage <- open_dataset("~/finalized/larval-w1118-testes/optimal_gep_usage", format='arrow')
w1118.gep_membership <- open_dataset("~/finalized/larval-w1118-testes/optimal_gep_membership", format='arrow')
xa.ratio.w1118 <- open_dataset("~/finalized/larval-w1118-testes/xa_ratio/", format='arrow') %>% collect()
hetchrom.ins <- open_dataset("~/finalized/hetchrom_assembly_insertions/", format='arrow')
rnaseq_pe <- open_dataset("~/finalized/rnaseq_pe/", format='arrow')
```

```{r data-02, cache=T}
optimal_qval <- 0.005

mods_all <- w1118.gep_membership %>% 
  collect() %>%
  filter(qval < optimal_qval)

te.lookup <- read_tsv('~/work/TestisTpn/data/te_id_lookup.curated.tsv.txt')

gtf <- import('~/work/TestisTpn/data/combined.fixed.gtf') %>%
  as_tibble()

tep.name <- w1118.gep_membership %>%
  filter(qval < optimal_qval) %>%
  collect() %>%
  left_join(te.lookup, by=c(X1='merged_te')) %>%
  filter(!str_detect(X1,'FBgn')) %>%
  dplyr::select(module, X1, repClass, repFamily) %>%
  distinct() %>%
  group_by(module) %>%
  summarize(n_tes=n()) %>%
  arrange(-n_tes) %>%
  head(1) %>%
  pull(module) %>% as.character()

tep.members <- w1118.gep_membership %>%
  filter(qval < optimal_qval) %>%
  collect() %>%
  filter(as.character(module)==tep.name) %>%
  pull(X1)


```

\newpage

```{r child='figure-01.Rmd', cache=T}

```

\newpage

```{r child='figure-02.Rmd', cache=T}

```

\newpage

```{r child='figure-03.Rmd', cache=T}

```

\newpage

```{r child='figure-04.Rmd', cache=T}

```

\newpage

```{r child='figure-05.Rmd', cache=T}

```

\newpage
